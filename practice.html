<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wrestling Practice Timer & Builder</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d111c; /* Dark background */
        }
        /* Custom scrollbar for activity list */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #3b82f6; /* Blue-500 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #1f2937; /* Gray-800 */
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen">
        <!-- Content will be injected here -->
    </div>

    <!-- Message Box Container -->
    <div id="message-box" class="fixed top-4 right-4 z-50 transition-transform duration-300 transform translate-x-full">
        <!-- Message content here -->
    </div>

    <script>
        // --- State Management (Vanilla JS equivalent of React state) ---
        let state = {
            mode: 'setup', // 'setup' or 'live'
            setupStep: 'details', // 'details', 'activities', 'schedule'
            practiceDate: '',
            startTime: '15:30',
            endTime: '17:00',
            activities: [], // Current schedule
            customActivities: [], // Saved custom activities (using localStorage for local convenience)
            selectedPresets: {}, // Temporary selection state
            
            // Live Timer State
            currentActivityIndex: 0,
            isRunning: false,
            elapsedSeconds: 0,
            intervalId: null,
            // Initialize currentTime once
            currentTime: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
        };

        // Static Presets
        const presetActivities = [
            { id: 'p1', title: 'Introductions & Warm-up', duration: 5, description: 'Introductions - Favorite Animal', category: 'Warm-up' },
            { id: 'p2', title: 'Warm Up for Success', duration: 5, description: 'Standing Still in own space', category: 'Warm-up' },
            { id: 'p3', title: '1 Legged Hop Competition', duration: 5, description: 'Fun and dynamic warm-up activity', category: 'Warm-up' },
            { id: 'p4', title: 'Shoulder Rolls', duration: 5, description: 'Progress to step out', category: 'Drill' },
            { id: 'p5', title: 'Hip Heists', duration: 5, description: 'Kick Throughs, Hip Heists', category: 'Drill' },
            { id: 'p6', title: 'Build a Base', duration: 5, description: 'Back inch worm, Knee Elbow Push Back Butt Over Heel', category: 'Drill' },
            { id: 'p7', title: 'Bottom Starting Position', duration: 5, description: 'Sit out protect popcorn, Turn Both ways', category: 'Drill' },
            { id: 'p8', title: 'TABLE WRESTLING', duration: 10, description: 'Break table to belly (Instruction and practice)', category: 'Technique' },
            { id: 'p9', title: 'Angle Knee Drop', duration: 5, description: 'Step Drop Shoulder - knee over toe', category: 'Drill' },
            { id: 'p10', title: 'Duck Walk', duration: 10, description: 'Jab step Knee over toe', category: 'Drill' },
            { id: 'p11', title: 'NOODLE SHOTS', duration: 20, description: 'Down Block, peal/wax off and circle, Noodle/Double leg practice', category: 'Technique' },
            { id: 'p12', title: 'Wall Climb Challenge', duration: 10, description: 'Back your feet up the wall', category: 'Challenge' },
            { id: 'p13', title: 'Cool Down & Wrap Up', duration: 5, description: 'Final stretch, water break, and closing remarks', category: 'Cool Down' },
        ];

        const STORAGE_KEY = 'wrestling-custom-activities';
        
        // --- Core Utilities ---

        function showMessage(message, type = 'info') {
            const box = document.getElementById('message-box');
            let bgColor = 'bg-blue-600';
            if (type === 'error') bgColor = 'bg-red-600';
            if (type === 'success') bgColor = 'bg-green-600';

            box.innerHTML = `
                <div class="${bgColor} text-white p-4 rounded-lg shadow-xl max-w-sm">
                    ${message}
                </div>
            `;
            box.classList.remove('translate-x-full');
            box.classList.add('translate-x-0');

            setTimeout(() => {
                box.classList.remove('translate-x-0');
                box.classList.add('translate-x-full');
            }, 3000);
        }

        function saveCustomActivities(activities) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(activities));
                state.customActivities = activities;
                render();
            } catch (e) {
                console.error("Could not save custom activities:", e);
                showMessage("Could not save custom activities locally.", 'error');
            }
        }

        function loadCustomActivities() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                state.customActivities = stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error("Could not load custom activities:", e);
                state.customActivities = [];
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function getCategoryColor(category) {
            const colors = {
                'Warm-up': 'bg-orange-600',
                'Drill': 'bg-blue-600',
                'Technique': 'bg-purple-600',
                'Challenge': 'bg-red-600',
                'Cool Down': 'bg-green-600'
            };
            return colors[category] || 'bg-gray-600';
        }

        function getTotalDuration() {
            return state.activities.reduce((sum, a) => sum + a.duration, 0);
        }

        function getProgressPercentage() {
            if (!state.activities.length) return 0;
            const totalSeconds = getTotalDuration() * 60;
            const completedSeconds = state.activities.slice(0, state.currentActivityIndex).reduce((sum, a) => sum + a.duration * 60, 0) + state.elapsedSeconds;
            return (completedSeconds / totalSeconds) * 100;
        }

        // --- Timer Logic ---
        function startTimer() {
            if (state.intervalId) return;

            state.isRunning = true;
            state.intervalId = setInterval(() => {
                state.elapsedSeconds += 1;
                
                const currentActivity = state.activities[state.currentActivityIndex];
                
                // IMPORTANT: Update current time display *inside* the main timer loop
                state.currentTime = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                if (currentActivity && state.elapsedSeconds >= currentActivity.duration * 60) {
                    // Activity completed
                    if (state.currentActivityIndex < state.activities.length - 1) {
                        state.currentActivityIndex += 1;
                        state.elapsedSeconds = 0;
                    } else {
                        // Practice finished
                        clearInterval(state.intervalId);
                        state.isRunning = false;
                        state.intervalId = null;
                        showMessage("Practice completed!", 'success');
                    }
                }
                
                render(); // Renders the UI every second
            }, 1000);
            render();
        }

        function pauseTimer() {
            if (state.intervalId) {
                clearInterval(state.intervalId);
            }
            state.isRunning = false;
            state.intervalId = null;
            render();
        }

        function toggleTimer() {
            if (state.activities.length === 0) {
                 showMessage("Please add activities to your schedule first.", 'error');
                 return;
            }
            if (state.currentActivityIndex >= state.activities.length) {
                // If practice is completed, clicking play should reset and start again
                resetTimer();
                startTimer();
                return;
            }

            if (state.isRunning) {
                pauseTimer();
                showMessage("Timer Paused.", 'info');
            } else {
                startTimer();
                showMessage("Timer Started!", 'success');
            }
        }

        function resetTimer() {
            pauseTimer();
            state.currentActivityIndex = 0;
            state.elapsedSeconds = 0;
            state.isRunning = false;
            render();
            showMessage("Practice Reset.", 'info');
        }

        // --- Render Functions ---

        function render() {
            const appDiv = document.getElementById('app');
            let html = '';

            if (state.mode === 'setup') {
                html = renderSetupMode();
            } else if (state.mode === 'live') {
                html = renderLiveMode();
            }

            appDiv.innerHTML = html;
        }

        function renderSetupMode() {
            const stepButtons = [
                { step: 'details', label: 'Practice Details', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><path d="M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8"/><path d="M19 16v6"/><path d="M16 19h6"/></svg>` },
                { step: 'activities', label: 'Select Activities', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5V15a2 2 0 0 1 2-2h8a2 2 0 0 0 2-2V5"/><path d="M18 13h4"/><path d="M18 17h4"/><path d="M4 5h8"/></svg>` },
                { step: 'schedule', label: 'Build Schedule', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>` },
            ];

            let content;
            if (state.setupStep === 'details') content = renderDetailsStep();
            if (state.setupStep === 'activities') content = renderActivitiesStep();
            if (state.setupStep === 'schedule') content = renderScheduleStep();


            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-900 via-gray-900 to-black text-white">
                    <div class="bg-gradient-to-r from-blue-800 to-blue-900 border-b-4 border-yellow-400 py-6 px-8">
                        <h1 class="text-5xl font-bold text-center bg-gradient-to-r from-yellow-400 via-white to-blue-400 bg-clip-text text-transparent">
                            Wrestling Practice Builder
                        </h1>
                    </div>

                    <!-- Step Navigation -->
                    <div class="bg-gray-800 border-b-2 border-gray-700">
                        <div class="max-w-7xl mx-auto px-8 py-4">
                            <div class="flex gap-4">
                                ${stepButtons.map((btn, index) => `
                                    <button
                                        data-action="set-step"
                                        data-step="${btn.step}"
                                        class="step-btn flex-1 py-4 px-6 rounded-lg font-bold text-lg transition-all flex items-center justify-center gap-3 ${
                                            state.setupStep === btn.step
                                                ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white border-2 border-yellow-400'
                                                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                        }"
                                    >
                                        ${btn.icon}
                                        <div>
                                            <div>Step ${index + 1}</div>
                                            <div class="text-sm">${btn.label}</div>
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div class="max-w-7xl mx-auto p-8">
                        ${content}
                    </div>
                </div>
            `;
        }

        function renderDetailsStep() {
            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-lg p-6 border-2 border-yellow-400">
                        <h2 class="text-3xl font-bold mb-2 text-yellow-400">Set Your Practice Details</h2>
                        <p class="text-white">Enter the date and time for your practice session</p>
                    </div>

                    <div class="bg-gray-800 rounded-lg p-8 border-2 border-blue-500">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-xl font-bold mb-3 text-blue-400">Practice Date</label>
                                <input
                                    data-state-key="practiceDate"
                                    type="date"
                                    value="${state.practiceDate}"
                                    class="input-state w-full bg-gray-700 border-2 border-gray-600 rounded-lg px-4 py-3 text-white text-lg focus:border-blue-500 focus:outline-none"
                                />
                            </div>
                            <div>
                                <label class="block text-xl font-bold mb-3 text-blue-400">Start Time</label>
                                <input
                                    data-state-key="startTime"
                                    type="time"
                                    value="${state.startTime}"
                                    class="input-state w-full bg-gray-700 border-2 border-gray-600 rounded-lg px-4 py-3 text-white text-lg focus:border-blue-500 focus:outline-none"
                                />
                            </div>
                            <div>
                                <label class="block text-xl font-bold mb-3 text-blue-400">End Time</label>
                                <input
                                    data-state-key="endTime"
                                    type="time"
                                    value="${state.endTime}"
                                    class="input-state w-full bg-gray-700 border-2 border-gray-600 rounded-lg px-4 py-3 text-white text-lg focus:border-blue-500 focus:outline-none"
                                />
                            </div>
                        </div>
                    </div>

                    <button
                        data-action="change-step"
                        data-target-step="activities"
                        class="next-step-btn w-full bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-400 hover:to-yellow-500 text-black rounded-lg py-6 text-2xl font-bold transition-all"
                    >
                        Next: Select Activities &rarr;
                    </button>
                </div>
            `;
        }
        
        function renderActivitiesStep() {
            const allActivities = [...presetActivities, ...state.customActivities];
            const selectedCount = Object.keys(state.selectedPresets).length;
            
            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-lg p-6 border-2 border-yellow-400">
                        <h2 class="text-3xl font-bold mb-2 text-yellow-400">Choose Your Activities</h2>
                        <p class="text-white">Click activities to select them, then adjust durations and add to your schedule</p>
                    </div>

                    <!-- Create Custom Activity Section (Simplified) -->
                    <div class="bg-gray-800 rounded-lg p-6 border-2 border-blue-500">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-bold text-blue-400">Custom Activities</h3>
                            <button
                                data-action="toggle-custom-form"
                                class="bg-yellow-500 hover:bg-yellow-600 text-black px-6 py-3 rounded-lg font-bold flex items-center gap-2"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
                                Create New Activity
                            </button>
                        </div>
                        
                        ${state.showCustomForm ? `
                            <div class="custom-form-container bg-gray-700 rounded-lg p-6 mb-4 border-2 border-yellow-400">
                                <h4 class="text-xl font-bold mb-4 text-yellow-400">New Custom Activity</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-bold mb-2">Activity Title *</label>
                                        <input type="text" id="custom-title" placeholder="e.g., Partner Takedown Drills" class="w-full bg-gray-800 border-2 border-gray-600 rounded px-4 py-2 text-white focus:border-blue-500 focus:outline-none" value="" />
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-bold mb-2">Duration (minutes) *</label>
                                            <input type="number" min="1" id="custom-duration" class="w-full bg-gray-800 border-2 border-gray-600 rounded px-4 py-2 text-white focus:border-blue-500 focus:outline-none" value="5" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-bold mb-2">Category</label>
                                            <select id="custom-category" class="w-full bg-gray-800 border-2 border-gray-600 rounded px-4 py-2 text-white focus:border-blue-500 focus:outline-none">
                                                <option value="Drill">Drill</option>
                                                <option value="Warm-up">Warm-up</option>
                                                <option value="Technique">Technique</option>
                                                <option value="Challenge">Challenge</option>
                                                <option value="Cool Down">Cool Down</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold mb-2">Description</label>
                                        <textarea id="custom-description" placeholder="Detailed instructions..." class="w-full bg-gray-800 border-2 border-gray-600 rounded px-4 py-2 text-white h-24 focus:border-blue-500 focus:outline-none"></textarea>
                                    </div>
                                    <div class="flex gap-3">
                                        <button data-action="add-custom-activity" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold">
                                            Save Activity
                                        </button>
                                        <button data-action="cancel-custom-form" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-bold">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${state.customActivities.length > 0 ? `
                            <div>
                                <p class="text-gray-400 mb-3">Your saved custom activities:</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                    ${state.customActivities.map(activity => `
                                        <div class="bg-gray-700 rounded-lg p-3 border border-gray-600 relative flex justify-between items-center">
                                            <div>
                                                <span class="${getCategoryColor(activity.category)} text-xs px-2 py-1 rounded text-white font-bold">${activity.category}</span>
                                                <div class="font-bold">${activity.title}</div>
                                                <div class="text-sm text-gray-400">${activity.duration} min</div>
                                            </div>
                                            <button data-id="${activity.id}" data-action="delete-custom-activity" class="text-red-400 hover:text-red-300">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>


                    <!-- Activity Library -->
                    <div class="bg-gray-800 rounded-lg p-6 border-2 border-blue-500">
                        <h3 class="text-2xl font-bold mb-4 text-blue-400">Activity Library (Presets + Custom)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 custom-scrollbar max-h-96 overflow-y-auto pr-2">
                            ${allActivities.map(activity => `
                                <button
                                    data-id="${activity.id}"
                                    data-action="toggle-preset-selection"
                                    class="rounded-lg p-4 text-left transition-all border-2 ${
                                        state.selectedPresets[activity.id]
                                            ? 'bg-gradient-to-r from-yellow-500 to-yellow-600 border-yellow-400 text-black scale-105 shadow-lg'
                                            : 'bg-gray-700 border-gray-600 hover:border-blue-400'
                                    }"
                                >
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="${getCategoryColor(activity.category)} text-xs px-2 py-1 rounded text-white font-bold">
                                            ${activity.category}
                                        </span>
                                        ${state.selectedPresets[activity.id] ? `<span class="text-2xl">âœ“</span>` : ''}
                                    </div>
                                    <div class="font-bold">${activity.title}</div>
                                    <div class="text-sm ${state.selectedPresets[activity.id] ? 'text-gray-900' : 'text-gray-400'}">
                                        ${activity.duration} min
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Selected Activities Preview -->
                    ${selectedCount > 0 ? `
                        <div class="bg-gray-800 rounded-lg p-6 border-2 border-yellow-400">
                            <h3 class="text-2xl font-bold mb-4 text-yellow-400">
                                Selected Activities (${selectedCount})
                            </h3>
                            <p class="text-gray-300 mb-4">Adjust durations before adding to schedule:</p>
                            <div class="space-y-3 mb-6">
                                ${Object.values(state.selectedPresets).map(preset => `
                                    <div class="flex items-center gap-4 bg-gray-700 rounded-lg p-4">
                                        <span class="${getCategoryColor(preset.category)} text-xs px-3 py-1 rounded text-white font-bold">
                                            ${preset.category}
                                        </span>
                                        <div class="flex-1 font-bold text-lg">${preset.title}</div>
                                        <input
                                            data-id="${preset.id}"
                                            data-action="update-preset-duration"
                                            type="number"
                                            min="1"
                                            value="${preset.duration}"
                                            class="w-24 bg-gray-900 border-2 border-blue-500 rounded-lg px-3 py-2 text-center text-yellow-400 font-bold text-lg"
                                        />
                                        <span class="text-gray-400 font-bold">min</span>
                                    </div>
                                `).join('')}
                            </div>
                            <button
                                data-action="add-selected-to-schedule"
                                class="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-400 hover:to-yellow-500 text-black rounded-lg py-4 text-xl font-bold flex items-center justify-center gap-2"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
                                Add ${selectedCount} Activities to Schedule
                            </button>
                        </div>
                    ` : ''}
                    
                    <div class="flex gap-4">
                        <button
                            data-action="change-step"
                            data-target-step="details"
                            class="flex-1 bg-gray-700 hover:bg-gray-600 text-white rounded-lg py-4 text-xl font-bold"
                        >
                            &larr; Back
                        </button>
                        <button
                            data-action="change-step"
                            data-target-step="schedule"
                            class="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white rounded-lg py-4 text-xl font-bold"
                        >
                            Next: Build Schedule &rarr;
                        </button>
                    </div>
                </div>
            `;
        }

        function renderScheduleStep() {
            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-lg p-6 border-2 border-yellow-400">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-3xl font-bold mb-2 text-yellow-400">Your Practice Schedule</h2>
                                <p class="text-white">Arrange activities in order and make final adjustments</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-300">Total Duration</div>
                                <div class="text-4xl font-bold text-yellow-400">${getTotalDuration()} min</div>
                            </div>
                        </div>
                    </div>
                    
                    ${state.activities.length === 0 ? `
                        <div class="bg-gray-800 rounded-lg p-12 border-2 border-gray-700 text-center">
                            <p class="text-xl text-gray-400 mb-4">No activities in your schedule yet</p>
                            <button
                                data-action="change-step"
                                data-target-step="activities"
                                class="next-step-btn bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-lg font-bold text-lg"
                            >
                                Go Back and Select Activities
                            </button>
                        </div>
                    ` : `
                        <div class="bg-gray-800 rounded-lg p-6 border-2 border-blue-500">
                            <div class="space-y-3">
                                ${state.activities.map((activity, idx) => `
                                    <div data-id="${activity.id}" class="activity-item bg-gray-700 rounded-lg p-4 flex items-center gap-3 border-2 border-gray-600 hover:border-blue-500 transition-all">
                                        <div class="flex flex-col gap-1">
                                            <button data-index="${idx}" data-action="move-activity" data-direction="up" class="text-blue-400 hover:text-blue-300 disabled:text-gray-600 disabled:cursor-not-allowed" ${idx === 0 ? 'disabled' : ''}>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 15 7-7 7 7"/></svg>
                                            </button>
                                            <button data-index="${idx}" data-action="move-activity" data-direction="down" class="text-blue-400 hover:text-blue-300 disabled:text-gray-600 disabled:cursor-not-allowed" ${idx === state.activities.length - 1 ? 'disabled' : ''}>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                                            </button>
                                        </div>
                                        <div class="text-2xl font-bold text-yellow-400 w-12 text-center">${idx + 1}</div>
                                        <span class="${getCategoryColor(activity.category)} text-xs px-3 py-1 rounded text-white font-bold">
                                            ${activity.category}
                                        </span>

                                        ${state.editingId === activity.id ? `
                                            <input type="text" id="edit-title-${activity.id}" value="${activity.title}" class="input-edit flex-1 bg-gray-600 border-2 border-gray-500 rounded px-3 py-2 text-white" />
                                            <input type="number" min="1" id="edit-duration-${activity.id}" value="${activity.duration}" class="input-edit w-20 bg-gray-600 border-2 border-gray-500 rounded px-3 py-2 text-white" />
                                            <button data-id="${activity.id}" data-action="save-activity" class="text-green-400 hover:text-green-300">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></svg>
                                            </button>
                                        ` : `
                                            <div class="flex-1">
                                                <div class="font-bold text-lg text-white">${activity.title}</div>
                                                <div class="text-sm text-gray-400">${activity.description}</div>
                                            </div>
                                            <div class="text-yellow-400 font-bold text-xl">${activity.duration} min</div>
                                            <button data-id="${activity.id}" data-action="edit-activity" class="text-blue-400 hover:text-blue-300">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                                            </button>
                                            <button data-id="${activity.id}" data-action="remove-activity" class="text-red-400 hover:text-red-300">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
                                            </button>
                                        `}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button
                                data-action="change-step"
                                data-target-step="activities"
                                class="flex-1 bg-gray-700 hover:bg-gray-600 text-white rounded-lg py-4 text-xl font-bold"
                            >
                                &larr; Add More Activities
                            </button>
                            <button
                                data-action="start-live-mode"
                                class="flex-1 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-400 hover:to-yellow-500 text-black rounded-lg py-4 text-xl font-bold flex items-center justify-center gap-3"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 14h-2V7h2M13 17h-2v-2h2"/></svg>
                                Start Practice Session
                            </button>
                        </div>
                    `}
                </div>
            `;
        }
        
        function renderLiveMode() {
            const currentActivity = state.activities[state.currentActivityIndex];
            const nextActivity = state.activities[state.currentActivityIndex + 1];
            const remainingSeconds = currentActivity ? (currentActivity.duration * 60) - state.elapsedSeconds : 0;
            const remainingTimeFormatted = formatTime(remainingSeconds);
            const isCompleted = state.currentActivityIndex >= state.activities.length;
            const currentTitle = isCompleted ? 'PRACTICE COMPLETE!' : currentActivity.title;
            const currentDescription = isCompleted ? 'Great work, Champions!' : currentActivity.description;

            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-900 via-gray-900 to-black text-white p-4">
                    <div class="max-w-7xl mx-auto">
                        <!-- Header -->
                        <div class="text-center mb-6">
                            <h1 class="text-6xl font-bold mb-2 bg-gradient-to-r from-yellow-400 via-blue-400 to-white bg-clip-text text-transparent">
                                WRESTLING PRACTICE
                            </h1>
                            <div class="text-3xl font-bold text-yellow-400 flex items-center justify-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                                <span id="current-time">${state.currentTime}</span>
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div class="bg-gray-800 rounded-full h-8 mb-6 overflow-hidden border-4 border-yellow-400">
                            <div
                                class="bg-gradient-to-r from-blue-500 via-blue-400 to-yellow-400 h-full transition-all duration-1000"
                                style="width: ${getProgressPercentage()}%;"
                            ></div>
                        </div>

                        <!-- Main Display -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <!-- Current Activity -->
                            <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-3xl p-8 border-4 border-yellow-400 shadow-2xl">
                                <div class="text-center">
                                    <div class="text-yellow-400 text-2xl font-bold mb-4">CURRENT ACTIVITY</div>
                                    <div class="text-6xl font-black mb-4 leading-tight text-white">${currentTitle}</div>
                                    <div class="text-2xl text-gray-200 mb-6">${currentDescription}</div>
                                    
                                    <!-- Giant Timer -->
                                    <div class="bg-black rounded-2xl p-8 mb-6 border-2 border-yellow-400">
                                        <div class="text-9xl font-black text-yellow-400 mb-2">
                                            ${remainingTimeFormatted}
                                        </div>
                                        <div class="text-2xl text-white">TIME REMAINING</div>
                                    </div>

                                    <div class="text-3xl font-bold text-white">
                                        ${isCompleted ? 'Finished!' : `Activity ${state.currentActivityIndex + 1} of ${state.activities.length}`}
                                    </div>
                                </div>
                            </div>

                            <!-- Next Activity -->
                            <div class="bg-gray-800 rounded-3xl p-8 border-4 border-blue-500">
                                <div class="text-center">
                                    <div class="text-blue-400 text-2xl font-bold mb-4">UP NEXT</div>
                                    ${nextActivity ? `
                                        <div class="text-5xl font-black mb-4 text-white">${nextActivity.title}</div>
                                        <div class="text-xl text-gray-300 mb-6">${nextActivity.description}</div>
                                        <div class="bg-gray-700 rounded-xl p-6 border-2 border-yellow-400">
                                            <div class="text-6xl font-black text-yellow-400">${nextActivity.duration}</div>
                                            <div class="text-xl text-gray-300">MINUTES</div>
                                        </div>
                                    ` : `
                                        <div class="text-4xl font-bold text-yellow-400 py-12">
                                            ðŸŽ‰ Last Activity! ðŸŽ‰
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div class="flex justify-center gap-4 mb-6">
                            <button
                                data-action="toggle-timer"
                                class="${state.isRunning ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-blue-600 hover:bg-blue-700'} rounded-full p-6 transition-all shadow-lg border-2 border-white text-white"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    ${state.isRunning ? '<rect width="6" height="16" x="9" y="4"/><rect width="6" height="16" x="15" y="4"/>' : '<polygon points="5 3 19 12 5 21 5 3"/>'}
                                </svg>
                            </button>
                            <button
                                data-action="reset-timer"
                                class="bg-gray-700 hover:bg-gray-600 rounded-full p-6 transition-all shadow-lg border-2 border-white text-white"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.76 2.76L3 7"/><path d="M3 3v4h4"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.76-2.76L21 17"/><path d="M21 21v-4h-4"/></svg>
                            </button>
                            <button
                                data-action="return-to-setup"
                                class="bg-gray-700 hover:bg-gray-600 rounded-full p-6 transition-all shadow-lg border-2 border-white text-white"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                            </button>
                        </div>

                        <!-- Full Schedule Timeline -->
                        <div class="bg-gray-800 rounded-2xl p-6 border-2 border-blue-500">
                            <h3 class="text-2xl font-bold mb-4 text-blue-400">Full Schedule</h3>
                            <div class="space-y-2 custom-scrollbar max-h-80 overflow-y-auto">
                                ${state.activities.map((activity, idx) => `
                                    <div
                                        class="rounded-lg p-4 flex items-center gap-4 transition-all ${
                                            idx === state.currentActivityIndex
                                                ? 'bg-gradient-to-r from-blue-600 to-blue-700 scale-[1.02] border-2 border-yellow-400'
                                                : idx < state.currentActivityIndex
                                                ? 'bg-gray-700 opacity-50'
                                                : 'bg-gray-700'
                                        }"
                                    >
                                        <div class="text-2xl font-bold w-8 text-yellow-400">${idx + 1}</div>
                                        <span class="${getCategoryColor(activity.category)} text-xs px-3 py-1 rounded text-white font-bold">
                                            ${activity.category}
                                        </span>
                                        <div class="flex-1">
                                            <div class="font-bold text-lg text-white">${activity.title}</div>
                                            <div class="text-sm text-gray-300">${activity.description}</div>
                                        </div>
                                        <div class="text-xl font-bold text-yellow-400">${activity.duration} min</div>
                                        ${idx === state.currentActivityIndex ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400 animate-pulse"><path d="M20 12h-8"/><path d="M10 2c-5.52 0-10 4.48-10 10s4.48 10 10 10 10-4.48 10-10"/></svg>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Event Delegation (New, Robust System) ---

        function handleGlobalClick(e) {
            const target = e.target.closest('[data-action]');
            if (!target) return;

            const action = target.dataset.action;
            const id = target.dataset.id;
            const index = parseInt(target.dataset.index);
            const direction = target.dataset.direction;
            const targetStep = target.dataset.targetStep;

            switch (action) {
                // Global Navigation
                case 'set-step':
                    state.setupStep = target.dataset.step;
                    render();
                    break;
                case 'change-step':
                    state.setupStep = targetStep;
                    render();
                    break;
                case 'start-live-mode':
                    if (state.activities.length === 0) {
                        showMessage("Add activities to your schedule first!", 'error');
                        return;
                    }
                    pauseTimer(); // Ensure any existing timer is stopped
                    state.mode = 'live';
                    state.currentActivityIndex = 0;
                    state.elapsedSeconds = 0;
                    state.isRunning = false;
                    render();
                    break;
                case 'return-to-setup':
                    pauseTimer();
                    state.mode = 'setup';
                    render();
                    break;

                // Live Mode Controls
                case 'toggle-timer':
                    toggleTimer();
                    break;
                case 'reset-timer':
                    resetTimer();
                    break;

                // Activity Setup Actions
                case 'toggle-custom-form':
                    state.showCustomForm = !state.showCustomForm;
                    render();
                    break;
                case 'cancel-custom-form':
                    state.showCustomForm = false;
                    render();
                    break;
                case 'add-custom-activity':
                    const title = document.getElementById('custom-title').value.trim();
                    const duration = parseInt(document.getElementById('custom-duration').value) || 5;
                    const description = document.getElementById('custom-description').value.trim();
                    const category = document.getElementById('custom-category').value;
                    
                    if (title) {
                        const newActivity = { id: 'c' + Date.now(), title, duration, description, category };
                        saveCustomActivities([...state.customActivities, newActivity]);
                        state.showCustomForm = false;
                    } else {
                        showMessage("Please enter a title for the custom activity.", 'error');
                    }
                    break;
                case 'delete-custom-activity':
                    saveCustomActivities(state.customActivities.filter(a => a.id !== id));
                    break;
                case 'toggle-preset-selection':
                    const all = [...presetActivities, ...state.customActivities];
                    const preset = all.find(a => a.id === id);

                    if (state.selectedPresets[id]) {
                        delete state.selectedPresets[id];
                    } else {
                        state.selectedPresets[id] = { ...preset, duration: preset.duration };
                    }
                    render();
                    break;
                case 'add-selected-to-schedule': { // Added scoping braces { }
                    const newActivities = Object.values(state.selectedPresets).map(preset => ({
                        ...preset,
                        id: 's' + Date.now() + Math.random()
                    }));
                    state.activities = [...state.activities, ...newActivities];
                    state.selectedPresets = {};
                    state.setupStep = 'schedule';
                    render();
                    break;
                } // Added scoping braces { }
                
                // Schedule Editing Actions
                case 'move-activity': { // Added scoping braces { }
                    const newActivities = [...state.activities];
                    const newIndex = direction === 'up' ? index - 1 : index + 1;
                    
                    if (newIndex >= 0 && newIndex < newActivities.length) {
                        [newActivities[index], newActivities[newIndex]] = [newActivities[newIndex], newActivities[index]];
                        state.activities = newActivities;
                        render();
                    }
                    break;
                } // Added scoping braces { }
                case 'remove-activity':
                    state.activities = state.activities.filter(a => a.id !== id);
                    render();
                    break;
                case 'edit-activity':
                    state.editingId = id;
                    render();
                    break;
                case 'save-activity':
                    const titleInput = document.getElementById(`edit-title-${id}`);
                    const durationInput = document.getElementById(`edit-duration-${id}`);
                    const newTitle = titleInput ? titleInput.value.trim() : '';
                    const newDuration = durationInput ? parseInt(durationInput.value) || 1 : 1;

                    if (newTitle) {
                        state.activities = state.activities.map(a => 
                            a.id === id ? { ...a, title: newTitle, duration: newDuration } : a
                        );
                        state.editingId = null;
                        showMessage("Activity Updated.", 'info');
                        render();
                    } else {
                        showMessage("Activity title cannot be empty.", 'error');
                    }
                    break;
            }
        }

        function handleGlobalInput(e) {
            const target = e.target;
            const stateKey = target.dataset.stateKey;
            
            if (stateKey) {
                state[stateKey] = target.value;
            }
            // Handle preset duration change directly on input
            if (target.dataset.action === 'update-preset-duration') {
                const id = target.dataset.id;
                state.selectedPresets[id].duration = parseInt(target.value) || 1;
            }
        }

        function setupGlobalListeners() {
            // Attach a single click listener to the main app container for ALL buttons
            document.getElementById('app').addEventListener('click', handleGlobalClick);

            // Attach a single input listener to the main app container for ALL inputs
            document.getElementById('app').addEventListener('input', handleGlobalInput);
        }
        
        // --- Initialization ---
        window.onload = function() {
            loadCustomActivities();
            setupGlobalListeners(); // Set up the single, permanent event listener
            render();
            // REMOVED the redundant, separate setInterval for current time display.
            // Current time is now updated inside the main startTimer loop.
        };
        
    </script>
</body>
</html>
